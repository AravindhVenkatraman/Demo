<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>CUSTOMER PORTAL</title>
    <style type="text/css">
        html, body {
            height: 100%;
            margin: 0;
            font-family: sans-serif;
        }
        .container {
            min-height: 100%;
            display: flex;
            flex-wrap: wrap;
            flex-direction: row;
        }
        .iframe {
            border: none;
        }
    </style>
</head>
<body>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-XXXXX-Y', {
          'cookieFlags': 'SameSite=None; Secure',
            },
            {
            allowLinker: true
        });
        ga('send', 'pageview');

        (function() {
            // Universal Analytics tracking ID whose _ga cookie to use.
            // If using GA4, you can leave this setting untouched.
            var trackingId = 'UA-XXXXX-Y';

            // Maximum time in milliseconds to wait for GA tracker to load.
            // Again, irrelevant for GA4.
            var maxGATime = 2000;

            // Set to the origin ("https://www.domain.com") of the iframe you want to communicate with
            var childOrigin = 'https://iqa.portal.gingr.io';

            // Don't touch anything that follows
            var pollInterval = 200;

            var postCallback = function(event) {
                console.log("WINDOW =>> ", window);
                console.log("EVENT =>> ", event);
                if (event.origin !== childOrigin) return;
                if (event.data !== 'childReady' && !event.data.event) return;
            
                if (event.data === 'childReady') {
                  // Send event that parent is ready
                  event.source.postMessage('parentReady', event.origin);
                
                  var pollCallback = function() {
                    // Stop polling if maxTime reached
                    maxGATime -= pollInterval;
                    if (maxGATime <= 0) window.clearInterval(poll);
                
                    // Only proceed if GA loaded and tracker accessible
                    var ga = window[window['GoogleAnalyticsObject']];
                    if (ga && ga.getAll) {
                      // Get tracker that matches the Tracking ID you provided
                      var tracker = ga.getAll().filter(function(t) { 
                        return t.get('trackingId') === trackingId; 
                      }).shift();

                      // Send message back to frame with Client ID
                      if (tracker) {
                        event.source.postMessage({
                          event: 'clientId',
                          clientId: tracker.get('clientId')
                        }, event.origin);
                      }
                      // Stop polling if not already done so
                      window.clearInterval(poll);
                    }
                  };

                  // Start polling for Google Analytics tracker
                  var poll = window.setInterval(pollCallback, pollInterval)
                }

                // Push dataLayer message from iframe to dataLayer of parent
                if (event.data.event) {
                  window.dataLayer.push(event.data);
                }
            };
    
            // Start listening for messages from child frame
            window.addEventListener('message', postCallback);
        })();

        (function() {
            // If not in iframe, do nothing
            try {
              if (window.top === window.self) return;
            } catch(e) {}

            // Set to false to prevent dataLayer messages from being sent to parent
            var sendDataLayerMessages = true;

            // Set the prefix that will be used in the event name, and under which all
            // the dataLayer properties will be embedded
            var dataLayerMessagePrefix = 'iframe';

            // Set to parent origin ("https://www.domain.com")
            var parentOrigin = 'https://www.parent-domain.com';
        
            // Maximum time in milliseconds to poll the parent frame for ready signal
            var maxTime = 2000;

            // Don't touch anything that follows
            var pollInterval = 200;
            var parentReady = false;

            var postCallback = function(event) {
              if (event.origin !== parentOrigin) return;
              if (event.data.event !== 'clientId' && event.data !== 'parentReady') return;
            
              if (event.data.event === 'clientId') {
                window.dataLayer.push({
                  event: 'clientId',
                  clientId: event.data.clientId
                });
              }

              if (event.data === 'parentReady' && !parentReady) {
                window.clearInterval(poll);
                if (sendDataLayerMessages) startDataLayerMessageCollection();
                parentReady = true;
              }
            };

            var pollCallback = function() {
              // If maximum time is reached, stop polling
              maxTime -= pollInterval;
              if (maxTime <= 0) window.clearInterval(poll);
              // Send message to parent that iframe is ready to retrieve Client ID
              window.top.postMessage('childReady', parentOrigin);
            };

            var createMessage = function(obj) {
              if (!Array.isArray(obj) && typeof obj === 'object') {
                var flattenObj = JSON.parse(JSON.stringify(obj));
	        	var message = {};
                // Add metadata about the page into the message
                message[dataLayerMessagePrefix] = {
                  pageData: {
                    url: document.location.href,
                    title: document.title
                  }
                };
                for (var prop in flattenObj) {
                  if (flattenObj.hasOwnProperty(prop) && prop !== 'gtm.uniqueEventId') {
                    if (prop === 'event') {
                      message.event = dataLayerMessagePrefix + '.' + flattenObj[prop];
                    } else {
                      message[dataLayerMessagePrefix][prop] = flattenObj[prop];
                    }
                  }
                }
                if (!message.event) message.event = dataLayerMessagePrefix + '.Message';
                return message;
              }
              return false;
            };

            var startDataLayerMessageCollection = function() {
              // Send the current dataLayer content to top frame, flatten the object
              window.dataLayer.forEach(function(obj) {
                var message = createMessage(obj);
                if (message) window.top.postMessage(message, parentOrigin);
              });
              // Create the push listener for future messages
              var oldPush = window.dataLayer.push;
              window.dataLayer.push = function() {
                var states = [].slice.call(arguments, 0);
                states.forEach(function(arg) {
                  var message = createMessage(arg);
                  if (message) window.top.postMessage(message, parentOrigin);
                });
                return oldPush.apply(window.dataLayer, states);
              };
            };

            // Start polling the parent page with "childReady" message
            var poll = window.setInterval(pollCallback, pollInterval);

            // Start listening for messages from the parent page
            window.addEventListener('message', postCallback);
        })();

    </script>

    <div class="container">
        <iframe
            src="https://iqa.portal.gingr.io/"
            title="Gingr" 
            width="100%"
            class="iframe"
        >
        </iframe>
    </div>

</body>
</html>